# 高度な図形（SPLINE, NURBS, Brep）

基本エンティティ（LINE, CIRCLE等）以外に、現代のCADで重要な役割を果たす高度な図形エンティティについて解説します。

## SPLINE（スプライン）

**導入バージョン**: AutoCAD R13 (AC1012)

DXFのスプラインは、**NURBS (Non-Uniform Rational B-Splines)** をベースにしています。

### 主要なグループコード

| コード | 説明 |
| :--- | :--- |
| `70` | スプラインフラグ（1=閉じた、2=定数、4=平面、8=線形） |
| `71` | 次数（Degree）: 通常は3（立方スプライン） |
| `72` | ノット数（Number of knots） |
| `73` | 制御点数（Number of control points） |
| `74` | フィット点数（Number of fit points） |
| `40` | ノット値（Knot value） |
| `10, 20, 30` | 制御点（Control point）の X, Y, Z 座標 |
| `11, 21, 31` | フィット点（Fit point）の X, Y, Z 座標 |
| `41` | 重み（Weight）: Rational Splineの場合に使用 |

### ベジェ曲線（Bezier Curves）との関係

DXFには「ベジェ曲線」という名前のエンティティは存在しません。
- **再現方法**: ベジェ曲線はNURBSの特殊なケース（ノットの配置が特定の条件を満たすもの）として表現されます。
- **実装**: ベジェ曲線を書き出したい場合は、スプラインエンティティとして保存します。

---

## 3DSOLID と Brep (Boundary Representation)

**導入バージョン**: AutoCAD R13

複雑な3D形状やソリッドモデルは `3DSOLID` や `REGION` エンティティとして格納されます。

### 特徴
- **ACISデータ**: DXF内部では、Spatial社の「ACIS」というモデリングカーネルのデータ（SAT形式）がテキストまたはバイナリで埋め込まれています。
- **タグ構造**: グループコード `1` または `3` に、ACISのデータ行が分割されて格納されます。
- **Brep**: ACISはBrep（境界表現）形式のデータです。

### 実装の難易度
- **極めて高い**: ACISのデータ形式は独自で、公開されている仕様もありますが、それをパースしてジオメトリ（頂点、エッジ、面）を復元するのは非常に困難です。
- **解決策**: 通常、エンジニアは `ezdxf` などの高度なライブラリを使用するか、3Dモデルをメッシュ（`MESH`）や三角形の集まり（`3DFACE`）に変換してからDXFに書き出す手法を取ります。

---

## CADソフトの対応具合

高度なエンティティのサポート状況はソフトによって異なります。

| エンティティ | AutoCAD / BricsCAD | LibreCAD | Webビューワー (three-dxf等) |
| :--- | :--- | :--- | :--- |
| `SPLINE` | ✅ 完全対応 | ✅ 表示可能 | ⚠️ 近似（線分分割） |
| `3DSOLID` | ✅ 完全対応 | ❌ 非対応 | ❌ 非対応 |
| `LWPOLYLINE` | ✅ 完全対応 | ✅ 完全対応 | ✅ 完全対応 |

### 実装時のアドバイス
- **互換性重視の場合**: `SPLINE` は短い `LINE` の連続（微小線分）に変換して出力するのが最も安全です。
- **3D形状の場合**: `3DSOLID` ではなく、`3DFACE`（ポリゴンメッシュ）として出力すると、多くのソフトで表示可能になります。

